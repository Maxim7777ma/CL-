{% extends "base.html" %}
{% load static %}

{% block title %}Пацієнт — {{ patient.full_name }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/patient.css' %}">
  <link rel="stylesheet" href="{% static 'css/doctor.css' %}">
{% endblock %}

{% block body_class %}page-doctor-patient-detail{% endblock %}

{% block content %}
<section class="dashboard dashboard--patient doctor-view-patient">
  <div class="dashboard__inner">

    <!-- Сайдбар: інфо про пацієнта + статистика -->
    <aside class="dashboard__sidebar">
      <div class="patient-card">
        <h2 class="patient-card__name">{{ patient.full_name }}</h2>
        {% if patient.age %}
          <div class="patient-card__age">Вік: {{ patient.age }} років</div>
        {% endif %}
        <div class="patient-card__phone">Телефон: {{ patient.phone }}</div>
        {% if patient.email %}
          <div class="patient-card__email">E-mail: {{ patient.email }}</div>
        {% endif %}
        {% if patient.branch %}
          <div class="patient-card__branch">Основний філіал: {{ patient.branch.name }}</div>
        {% endif %}
      </div>

      <div class="patient-card patient-card--secondary">
        <h3>Статистика по пацієнту</h3>
        <ul class="doctor-summary">
          <li class="doctor-summary__item">
            <span class="doctor-summary__label">Усього візитів:</span>
            <span class="doctor-summary__value">{{ stats.total_visits }}</span>
          </li>
          <li class="doctor-summary__item">
            <span class="doctor-summary__label">Завершених:</span>
            <span class="doctor-summary__value">{{ stats.completed_visits }}</span>
          </li>
          <li class="doctor-summary__item">
            <span class="doctor-summary__label">Скасовано / не зʼявився:</span>
            <span class="doctor-summary__value">{{ stats.cancelled_visits }}</span>
          </li>
          <li class="doctor-summary__item">
            <span class="doctor-summary__label">Перше відвідування:</span>
            <span class="doctor-summary__value">
              {% if stats.first_visit %}
                {{ stats.first_visit.date|date:"d.m.Y" }}
              {% else %}-{% endif %}
            </span>
          </li>
          <li class="doctor-summary__item">
            <span class="doctor-summary__label">Останнє відвідування:</span>
            <span class="doctor-summary__value">
              {% if stats.last_visit %}
                {{ stats.last_visit.date|date:"d.m.Y" }}
              {% else %}-{% endif %}
            </span>
          </li>
          <li class="doctor-summary__item">
            <span class="doctor-summary__label">Орієнтовна сума:</span>
            <span class="doctor-summary__value">
              {{ stats.total_amount|floatformat:0 }} грн
            </span>
          </li>
        </ul>
      </div>

      <!-- Документи пацієнта -->
      <div class="patient-card patient-card--secondary">
        <h3>Документи пацієнта</h3>
        {% if documents %}
          <ul class="patient-docs-list">
            {% for doc in documents %}
              <li class="patient-docs-list__item">
                {% if doc.file %}
                  <a href="{{ doc.file.url }}" target="_blank">
                    {{ doc.title|default:"Документ" }}
                  </a>
                  <span class="patient-docs-list__tag">
                    {% with ext=doc.file.name|slice:"-4:" %}
                      {% if ext == ".pdf" or ext == "pdf" %}
                        PDF
                      {% else %}
                        Файл
                      {% endif %}
                    {% endwith %}
                  </span>
                {% else %}
                  <span class="patient-docs-list__nofile">
                    {{ doc.title }} <span>(файл ще не завантажено)</span>
                  </span>
                {% endif %}
                <span class="patient-docs-list__date">
                  {{ doc.created_at|date:"d.m.Y" }}
                </span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>Документів ще немає.</p>
        {% endif %}
      </div>
    </aside>

    <!-- Права частина: статистика послуг + візити -->
    <div class="dashboard__content">
      <!-- Діаграма послуг -->
      <section class="dashboard-section dashboard-section--chart">
        <h3 class="dashboard-section__title">Які послуги отримував пацієнт</h3>
        {% if stats.service_stats %}
          <ul class="service-chart">
            {% for s in stats.service_stats %}
              <li class="service-chart__item">
                <div class="service-chart__label">
                  <span class="service-chart__name">{{ s.name }}</span>
                  <span class="service-chart__value">
                    {{ s.amount|floatformat:0 }} грн · {{ s.count }} візит{% if s.count != 1 %}и{% endif %}
                  </span>
                </div>
                <div class="service-chart__bar-wrap">
                  {# можно было бы сделать проценты, но для пациента хватит относительной длины #}
                  <div class="service-chart__bar" style="--bar-width: 100%; opacity: {{ forloop.counter0|add:2|divisibleby:10 }};"></div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>Поки немає завершених візитів з послугами.</p>
        {% endif %}
      </section>

      <!-- Таблиця візитів -->
      <!-- Фільтри + список візитів картками -->
      <section class="dashboard-section">
        <div class="dashboard-section__header">
          <h3 class="dashboard-section__title">
            Візити пацієнта ({{ appointments_page.paginator.count }})
          </h3>
        </div>

        <!-- ФІЛЬТРИ -->
        <form method="get" class="patient-filter patient-filter--doctor">
          <div class="patient-filter__row">
            <div class="patient-filter__field">
              <label for="start_date">Від дати</label>
              <input
                type="date"
                id="start_date"
                name="start_date"
                value="{{ filters.start_date }}"
              >
            </div>
            <div class="patient-filter__field">
              <label for="end_date">До дати</label>
              <input
                type="date"
                id="end_date"
                name="end_date"
                value="{{ filters.end_date }}"
              >
            </div>
            <div class="patient-filter__field">
              <label for="service_filter">Послуга</label>
              <select id="service_filter" name="service">
                <option value="">Усі послуги</option>
                {% for s in services_all %}
                  <option value="{{ s.id }}" {% if s.id|stringformat:"s" == filters.service_id %}selected{% endif %}>
                    {{ s.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="patient-filter__actions">
              <button type="submit" class="btn btn--small">Застосувати</button>
              <a href="{% url 'doctor_patient_detail' patient.id %}" class="btn btn--small btn--ghost">
                Скинути
              </a>
            </div>
          </div>
        </form>

        <!-- СПИСОК ВІЗИТІВ КАРТКАМИ -->
        <div class="appointments-list">
          {% for app in appointments_page %}
            <article class="appointment-card"
                     data-appointment-card
                     data-update-url="{% url 'api_update_appointment' app.id %}">
              <header class="appointment-card__header">
                <div class="appointment-card__main">
                  <div class="appointment-card__date-time">
                    <span class="appointment-card__date">
                      {{ app.date|date:"d.m.Y" }}
                    </span>
                    <span class="appointment-card__time">
                      {{ app.time|time:"H:i" }}
                    </span>
                  </div>
                  <div class="appointment-card__status appointment-card__status--{{ app.status }}">
                    {{ app.get_status_display }}
                  </div>
                </div>
                <div class="appointment-card__meta">
                  <div class="appointment-card__line">
                    <span class="appointment-card__label">Лікар:</span>
                    <span class="appointment-card__value">
                      {% if app.doctor %}{{ app.doctor.full_name }}{% else %}-{% endif %}
                    </span>
                  </div>
                  <div class="appointment-card__line">
                    <span class="appointment-card__label">Філіал:</span>
                    <span class="appointment-card__value">{{ app.branch.name }}</span>
                  </div>
                </div>
              </header>

              <div class="appointment-card__body">
                <div class="appointment-card__field">
                  <label>Послуга</label>
                  <select class="appointment-card__service-select"
                          data-service-select>
                    <option value="">Не вказано</option>
                    {% for s in services_all %}
                      <option value="{{ s.id }}"
                        {% if app.service and s.id == app.service.id %}selected{% endif %}>
                        {{ s.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="appointment-card__field appointment-card__field--comment">
                  <div class="appointment-card__comment-top">
                    <div class="appointment-card__comment-label">
                      Коментар лікаря
                    </div>
                    <button type="button"
                            class="appointment-card__comment-toggle"
                            data-comment-toggle>
                      Розгорнути
                    </button>
                  </div>

                  <div class="appointment-card__comment-summary" data-comment-summary>
                    {% if app.note %}
                      {{ app.note|truncatechars:80 }}
                    {% else %}
                      <span class="appointment-card__comment-empty">Коментар ще не додано.</span>
                    {% endif %}
                  </div>

                  <div class="appointment-card__comment-body" data-comment-body>
                    <textarea
                      class="appointment-card__comment-input"
                      rows="3"
                      data-comment-input
                      data-original-note="{{ app.note|default:''|escape }}">
                      {{ app.note }}
                    </textarea>
                    <div class="appointment-card__comment-actions">
                      <button type="button"
                              class="btn btn--small"
                              data-comment-save>
                        Зберегти
                      </button>
                      <button type="button"
                              class="btn btn--small btn--ghost"
                              data-comment-cancel>
                        Скасувати
                      </button>
                    </div>
                    <div class="appointment-card__comment-status"
                         data-comment-status></div>
                  </div>
                </div>
              </div>
            </article>
          {% empty %}
            <p>Візитів поки немає.</p>
          {% endfor %}
        </div>

        <!-- ПАГІНАЦІЯ -->
        {% if appointments_page.has_other_pages %}
          <div class="pagination">
            {% if appointments_page.has_previous %}
              <a class="pagination__link"
                 href="?page={{ appointments_page.previous_page_number }}{{ filters.qs_base }}">
                ← Назад
              </a>
            {% endif %}

            <span class="pagination__info">
              Сторінка {{ appointments_page.number }}
              з {{ appointments_page.paginator.num_pages }}
            </span>

            {% if appointments_page.has_next %}
              <a class="pagination__link"
                 href="?page={{ appointments_page.next_page_number }}{{ filters.qs_base }}">
                Далі →
              </a>
            {% endif %}
          </div>
        {% endif %}
      </section>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/patient.js' %}"></script>
{% endblock %}
